import sqlite3
import logging
from datetime import datetime
import pytz
from cryptography.fernet import Fernet
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder, CommandHandler, CallbackQueryHandler,
    MessageHandler, ContextTypes, filters
)

# ================= CONFIG =================
TOKEN = "8493844166:AAE5bkaairwfXGD7pJCBZTQ7Dqy-mgM2gj8"
OWNER_IDS = [6361374151, 8209644174]
SECRET_KEY = b'0mBl7VBelC7fPvZsjj0l6RGxHDwrjlHZixYWUC68gPU='
WIB = pytz.timezone("Asia/Jakarta")

PAYMENT_INFO = """üí≥ PAYMENT INFO üí≥
QR: https://ibb.co/7t54RddV
Shopeepay: 081219623569 A/n rifkxxx
"""

cipher = Fernet(SECRET_KEY)
logging.basicConfig(level=logging.INFO)

pending_products = {}

# ================= UTIL =================
def now_wib():
    return datetime.now(WIB).strftime("%d-%m-%Y %H:%M:%S WIB")

def encrypt(text):
    return cipher.encrypt(text.encode()).decode()

# ================= DATABASE =================
conn = sqlite3.connect("store.db", check_same_thread=False)
cursor = conn.cursor()

cursor.execute("CREATE TABLE IF NOT EXISTS users (user_id INTEGER PRIMARY KEY)")
cursor.execute("CREATE TABLE IF NOT EXISTS admins (user_id INTEGER PRIMARY KEY)")
cursor.execute("""CREATE TABLE IF NOT EXISTS categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nama TEXT UNIQUE
)""")
cursor.execute("""CREATE TABLE IF NOT EXISTS products (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nama TEXT,
    kategori_id INTEGER,
    deskripsi TEXT,
    file TEXT
)""")
cursor.execute("""CREATE TABLE IF NOT EXISTS transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    product_id INTEGER,
    status TEXT,
    tanggal TEXT
)""")
conn.commit()

# ================= ROLE =================
def is_owner(uid):
    return uid in OWNER_IDS

# ================= START =================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    cursor.execute("INSERT OR IGNORE INTO users VALUES (?)", (uid,))
    conn.commit()

    cursor.execute("SELECT * FROM categories")
    cats = cursor.fetchall()

    keyboard = [[InlineKeyboardButton(c[1], callback_data=f"cat_{c[0]}")] for c in cats]
    keyboard.append([InlineKeyboardButton("‚ùì HELP", callback_data="help")])

    await update.message.reply_text(
        "üî• GARFIELD STORE üî•\nPilih kategori:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================= HELP =================
async def help_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = """üìñ HELP MENU

Cara beli:
1. /start
2. Pilih kategori
3. Klik produk
4. Klik BELI
5. Transfer
6. Kirim foto bukti

Owner:
/addkategori Nama
/delkategori ID
/listkategori
/addproduk NamaProduk
/delproduk ID
"""
    keyboard = [[InlineKeyboardButton("üîô Kembali", callback_data="back_start")]]

    await update.callback_query.answer()
    await update.callback_query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================= CATEGORY =================
async def addkategori(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_owner(update.effective_user.id):
        return
    nama = " ".join(context.args)
    if not nama:
        await update.message.reply_text("Format: /addkategori NamaKategori")
        return
    cursor.execute("INSERT OR IGNORE INTO categories (nama) VALUES (?)", (nama,))
    conn.commit()
    await update.message.reply_text("Kategori ditambahkan.")

async def delkategori(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_owner(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("Format: /delkategori ID")
        return
    cid = int(context.args[0])
    cursor.execute("DELETE FROM categories WHERE id=?", (cid,))
    conn.commit()
    await update.message.reply_text("Kategori dihapus.")

async def listkategori(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_owner(update.effective_user.id):
        return
    cursor.execute("SELECT * FROM categories")
    cats = cursor.fetchall()
    text = "\n".join([f"{c[0]} - {c[1]}" for c in cats])
    await update.message.reply_text(text or "Kosong.")

# ================= ADD PRODUK =================
async def addproduk(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_owner(update.effective_user.id):
        return

    nama = " ".join(context.args).strip()
    if not nama:
        await update.message.reply_text("Format: /addproduk NamaProduk")
        return

    cursor.execute("SELECT * FROM categories")
    cats = cursor.fetchall()

    if not cats:
        await update.message.reply_text("Belum ada kategori.")
        return

    pending_products[update.effective_user.id] = nama

    keyboard = [[InlineKeyboardButton(c[1], callback_data=f"addcat_{c[0]}")] for c in cats]

    await update.message.reply_text(
        "Pilih kategori:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def addproduk_kategori(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    uid = query.from_user.id
    if uid not in pending_products:
        await query.edit_message_text("Tidak ada produk diproses.")
        return

    cat_id = int(query.data.split("_")[1])
    nama = pending_products[uid]

    cursor.execute(
        "INSERT INTO products (nama, kategori_id, deskripsi, file) VALUES (?, ?, ?, ?)",
        (nama, cat_id, "", encrypt(""))
    )
    conn.commit()

    del pending_products[uid]
    await query.edit_message_text(f"Produk '{nama}' berhasil ditambahkan.")

# ================= DELETE PRODUK =================
async def delproduk(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_owner(update.effective_user.id):
        return

    if not context.args:
        await update.message.reply_text("Format: /delproduk ID")
        return

    try:
        pid = int(context.args[0])
    except:
        await update.message.reply_text("ID harus angka.")
        return

    cursor.execute("SELECT * FROM products WHERE id=?", (pid,))
    cek = cursor.fetchone()

    if not cek:
        await update.message.reply_text("Produk tidak ditemukan.")
        return

    cursor.execute("DELETE FROM products WHERE id=?", (pid,))
    conn.commit()

    await update.message.reply_text(f"Produk ID {pid} berhasil dihapus.")

# ================= LIST PRODUK USER =================
async def list_produk(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    cat_id = int(query.data.split("_")[1])
    cursor.execute("SELECT * FROM products WHERE kategori_id=?", (cat_id,))
    prods = cursor.fetchall()

    if not prods:
        await query.edit_message_text("Produk kosong.")
        return

    keyboard = [[InlineKeyboardButton(p[1], callback_data=f"detail_{p[0]}")] for p in prods]

    await query.edit_message_text(
        "üì¶ List Produk:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================= DETAIL =================
async def detail_produk(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    pid = int(query.data.split("_")[1])
    cursor.execute("SELECT * FROM products WHERE id=?", (pid,))
    p = cursor.fetchone()

    keyboard = [
        [InlineKeyboardButton("üõí BELI", callback_data=f"buy_{pid}")],
        [InlineKeyboardButton("üîô Kembali", callback_data=f"cat_{p[2]}")]
    ]

    await query.edit_message_text(
        f"üì¶ {p[1]}\n\n{PAYMENT_INFO}",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================= BUY =================
async def buy(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    uid = query.from_user.id
    pid = int(query.data.split("_")[1])

    cursor.execute(
        "INSERT INTO transactions (user_id, product_id, status, tanggal) VALUES (?, ?, ?, ?)",
        (uid, pid, "PENDING", now_wib())
    )
    conn.commit()

    await query.edit_message_text("Transfer sesuai info.\nKirim foto bukti pembayaran.")

# ================= FOTO BUKTI =================
async def bukti(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.message.from_user.id

    cursor.execute(
        "SELECT * FROM transactions WHERE user_id=? AND status='PENDING' ORDER BY id DESC",
        (uid,)
    )
    trx = cursor.fetchone()

    if not trx:
        return

    keyboard = [[
        InlineKeyboardButton("‚úÖ ACC", callback_data=f"acc_{trx[0]}"),
        InlineKeyboardButton("‚ùå CANCEL", callback_data=f"cancel_{trx[0]}")
    ]]

    await context.bot.send_photo(
        OWNER_IDS[0],
        update.message.photo[-1].file_id,
        caption=f"User: {uid}\nTRX: {trx[0]}",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    await update.message.reply_text("Bukti dikirim ke admin.")

# ================= ACC / CANCEL =================
async def acc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    trx_id = int(query.data.split("_")[1])
    cursor.execute("UPDATE transactions SET status='SUCCESS' WHERE id=?", (trx_id,))
    conn.commit()
    await query.edit_message_caption("TRANSACTION SUCCESS")

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    trx_id = int(query.data.split("_")[1])
    cursor.execute("UPDATE transactions SET status='CANCEL' WHERE id=?", (trx_id,))
    conn.commit()
    await query.edit_message_caption("TRANSACTION CANCELLED")

# ================= ERROR HANDLER =================
async def error_handler(update, context):
    logging.error("ERROR:", exc_info=context.error)

# ================= MAIN =================
app = ApplicationBuilder().token(TOKEN).build()

app.add_error_handler(error_handler)

app.add_handler(CommandHandler("start", start))
app.add_handler(CommandHandler("addkategori", addkategori))
app.add_handler(CommandHandler("delkategori", delkategori))
app.add_handler(CommandHandler("listkategori", listkategori))
app.add_handler(CommandHandler("addproduk", addproduk))
app.add_handler(CommandHandler("delproduk", delproduk))

app.add_handler(CallbackQueryHandler(help_menu, pattern="help"))
app.add_handler(CallbackQueryHandler(start, pattern="back_start"))
app.add_handler(CallbackQueryHandler(addproduk_kategori, pattern="addcat_"))
app.add_handler(CallbackQueryHandler(list_produk, pattern="cat_"))
app.add_handler(CallbackQueryHandler(detail_produk, pattern="detail_"))
app.add_handler(CallbackQueryHandler(buy, pattern="buy_"))
app.add_handler(CallbackQueryHandler(acc, pattern="acc_"))
app.add_handler(CallbackQueryHandler(cancel, pattern="cancel_"))

app.add_handler(MessageHandler(filters.PHOTO, bukti))

app.run_polling()
